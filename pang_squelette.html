<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Jeu pang</title>
    <script>

    // ------------------------------
    //  Variables
    // ------------------------------

    // context
    var context = null;
    
    // Pause
    var playing = true;
    var pause = false;

    // rectangle dans le jeu :
    var rectangle = { x: 0, y: 0, hauteur: 0, largeur: 0, couleur: "" };
    
    // Ballon
    var ballon = {center: {x: 0, y:0}, radius:100, velocity:{ x: 1, y: 0}, gravity: {x :0, y: 9.81/1000}, color:"red"};
    
    //LastUpdate
    var lastUpdate = Date.now();
    
    // player
    var player = {position: {x: 0, y: 0}, speed: {x: 0, y: 0}, height: 0, width: 0, powerOn: 0, shieldOn: 0, score: 0, livesNumber: 3};
    const PLAYER_SPEED = 500;

    // gravite
    const GRAVITY = {x: 0, y: 9.81};

   
    // ------------------------------
    //  Functions
    // ------------------------------

    playerMove = function(move) {
        if(move == 39) {
            player.speed.x = PLAYER_SPEED;
        } else {
            player.speed.x = -PLAYER_SPEED;
        }
    }

    playerStopMove = function(move) {
        if(move == 39) {
            player.speed.x = 0;
        } else {
            player.speed.x = 0;
        }
    }

    keepPlayerWithinBorder = function() {
        if(player.position.x < 0) {
            player.position.x = 0;
        } else {
            if(player.position.x > context.width-player.width) {
                player.position.x = context.width-player.width
            }
        }

        if(player.position.y < 0) {
            player.position.y = 0;
        } else {
            if(player.position.y > context.height-player.height) {
                player.position.y = context.height-player.height
            }
        }
    }

    // ------------------------------
    //  Game
    // ------------------------------

    /**
     * Initialisation
     */
    init = function() {
        // instanciation de la variable globale contenant le contexte
        context = document.getElementById("cvs").getContext("2d");
        context.width = document.getElementById("cvs").width;
        context.height = document.getElementById("cvs").height;

        //Pause if 
        document.body.onblur = function() {
            playing = false;
        }
        document.body.onfocus = function() {
            playing = true;
        }


        // The ballon is in the middle top
        ballon.center.x = cvs.width/2;
        ballon.center.y =  ballon.radius + 2;

        // on associe au document des écouteurs d'événements
        // --> voir http://www.w3schools.com/js/js_events.asp

        // 2 écouteurs pour le clavier (appui/relâchement d'une touche)
        // écouteurs
        document.addEventListener("keydown", captureAppuiToucheClavier)
        document.addEventListener("keyup", captureRelacheToucheClavier)

        // initialisation du joueur
        player.height = 75;
        player.width = 75;
        player.position.x = context.width/2 - player.width/2;
        player.position.y = context.height - player.height;

        // lancement de la boucle de jeu
        boucleDeJeu();
    }

    /*
     * Game loop
     */
    boucleDeJeu = function() {
        var delta = Date.now()-lastUpdate;
        lastUpdate = Date.now();

        if(playing && !pause){
            // mise à jour de l'état du jeu
            update(delta);
            // affichage de l'état du jeu
            render();
        }
        // rappel de la boucle de jeu
        //  http://www.html5canvastutorials.com/advanced/html5-canvas-animation-stage/
        requestAnimationFrame(boucleDeJeu);
    }

    // KeepBallonWithinBorders()
    function KeepBallonWithinBorders(ballon){
        //Top
        if(ballon.center.y < ballon.radius){
            ballon.center.y = ballon.radius;
            ballon.velocity.y = -ballon.velocity.y;
        } else {
            //Bottom
            if(ballon.center.y > cvs.height - ballon.radius){
                ballon.center.y = cvs.height - ballon.radius;
                ballon.velocity.y = -ballon.velocity.y;
            }
        }
        //Left
        if(ballon.center.x < ballon.radius){
            ballon.center.x = ballon.radius;
            ballon.velocity.x = -ballon.velocity.x;
        } else {
            //Right
            if(ballon.center.x > cvs.width-ballon.radius){
                ballon.center.x = cvs.width - ballon.radius;
                ballon.velocity.x = -ballon.velocity.x;
            }
        }
        return(ballon);
    }

  
    /**
     *  Game update
     *  @param  d   current date
     */
    update = function(delta) {
        
        // Update ballon.velocity
        ballon.velocity.x += ballon.gravity.x*delta;
        ballon.velocity.y += ballon.gravity.y*delta;

        // Update ballon.center
        ballon.center.x += ballon.velocity.x * delta;
        ballon.center.y += ballon.velocity.y * delta; 
        
        //KeepBallonWithinBorders()
        KeepBallonWithinBorders(ballon);
   

        // déplacement du personnage
        var newPosXPlayer = player.position.x + player.speed.x*delta/1000, newPosYPlayer = player.position.y + player.speed.y*delta/1000;
        player.position.x = newPosXPlayer;
        player.position.y = newPosYPlayer;
        keepPlayerWithinBorder();
    }


    /**
     *  Game render
     */
    render = function() {
        // effacement de l'écran
        context.clearRect(0, 0, context.width, context.height);
        
        // like FillRect, but for circles
        function fillCircle(circle)        {
        var canvas = document.getElementById("cvs");
        var context = canvas.getContext("2d");
        context.beginPath();
        context.fillStyle=circle.color
        context.arc(circle.center.x, circle.center.y, circle.radius, 0, 2 * Math.PI);
        context.fill();
        }
         

        // Ballon displaying
        fillCircle(ballon);

        // affichage du joueur
        context.fillStyle = "blue";
        context.fillRect(player.position.x, player.position.y, player.height, player.width);
    }


    /**
     *  Key down event
     */
    captureAppuiToucheClavier = function(event) {
        switch (event.keyCode) {
            case 39:
            case 37:
                playerMove(event.keyCode);
            break;
            case 80:
                pause = !pause;
            break;

        }
    }

    /**
     *  Key up event
     */
    captureRelacheToucheClavier = function(event) {
        switch (event.keyCode) {
            case 39:
            case 37:
                playerStopMove(event.keyCode);
        }
    }

    </script>
</head>

<body onload="init()">

    <canvas id="cvs" width="1920" height="1080" style="margin: 10px auto; border: solid 1px #000;"></canvas>

</body>

</html>
